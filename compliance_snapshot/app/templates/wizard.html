<!DOCTYPE html><html><head>
  <meta charset="utf-8" />
  <title>Snapshot Wizard</title>

  <!-- libs -->
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/scroller/2.1.1/css/scroller.dataTables.min.css"/>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/scroller/2.1.1/js/dataTables.scroller.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body{font-family:Arial,Helvetica,sans-serif;padding:2rem}
    nav button{margin-right:.5rem;margin-bottom:1rem}
    #preview{width:540px;height:300px;margin-top:1rem;border:1px solid #ccc}
    #tbl{width:100%}
  </style>
</head><body>
  <h2>Compliance Snapshot â€“ Wizard</h2>

  <!-- Tabs will be built by JS -->
  <nav id="tabs"></nav>

  <!-- Finalize form: generates PDF on submit -->
  <form id="finalize-form" data-ticket="{{ ticket }}">
    <!-- DataTable injected here -->
    <div id="table-area"></div>

    <label style="display:block;margin:.5rem 0">
      Chart&nbsp;type:
      <select id="chart-type">
        <option value="bar" selected>Bar</option>
        <option value="pie">Pie</option>
      </select>
    </label>
    <!-- hidden field that goes to /finalize -->
    <input type="hidden" name="chart_type" id="chart-type-hidden" value="bar">


    <!-- Chart preview -->
    <canvas id="preview" class="hidden"></canvas>

    <input type="hidden" name="filter_search" id="filter-search-hidden" value="">

    <label style="display:block;margin:1rem 0">
      Trend&nbsp;end&nbsp;date:
      <input type="date" name="trend_end" id="trend-end">
      <small>(defaults to latest week if left blank)</small>
    </label>

    <button id="build-pdf" type="submit">Build PDF</button>
  </form>

<script>
const ticket = "{{ ticket }}";

// ---------- build tab buttons ----------
async function loadTabs(){
  const res = await fetch(`/api/${ticket}/tables`);
  const tables = await res.json();
  const nav = document.getElementById('tabs');
  tables.forEach(name=>{
    const btn = document.createElement('button');
    btn.type = "button";
    btn.textContent = name.toUpperCase();
    btn.onclick = ()=> openTab(name);
    nav.appendChild(btn);
  });
}
loadTabs();

// ---------- open tab, render table & chart ----------
async function openTab(table){
  const res = await fetch(`/api/${ticket}/query?table=${table}`);
  const {columns, rows} = await res.json();
  window.tableName = table;  // remember current table

  window.activeFilters = window.activeFilters || {};
  const filters = window.activeFilters;

  // build HTML table
  const area = document.getElementById('table-area');
  area.innerHTML = `<div id="filters" style="margin-bottom:.5rem"></div>
    <table id="tbl"><thead><tr>${
      columns.map(c=>`<th>${c}</th>`).join('')
    }</tr></thead><tbody></tbody></table>`;
  const tbody = area.querySelector('tbody');
  rows.forEach(r=>{
    tbody.insertRow().innerHTML = r.map(v=>`<td>${v}</td>`).join('');
  });
  const dt      = $('#tbl').DataTable({
    lengthMenu: [[10,25,50,100,-1],[10,25,50,100,'All']],
    pageLength: 10
  });
  window.allRows = dt.rows().data().toArray();              // snapshot of full data

  function updatePreview(){
      const table     = $('#tbl').DataTable();
      const searchStr = table.search();

      // propagate hidden fields for /finalize
      $('#filter-search-hidden').val(searchStr);
      $('#chart-type-hidden').val(document.getElementById('chart-type').value);

      document.getElementById('preview').classList.remove('hidden');

      const rows = searchStr ? table.rows({search:'applied'}).data().toArray()
                             : window.allRows;
      const cols = table.columns().header().toArray().map(th=>th.innerText);
      drawChart('hos', rows, cols);
  }

  $('#tbl').on('draw.dt', updatePreview);       // fires after search OR pagination
  document.getElementById('chart-type')
          .addEventListener('change', updatePreview);

  // initial render
  updatePreview();

  // build column filters
  const filtersDiv = document.getElementById('filters');
  filtersDiv.innerHTML = '';
  columns.forEach((col, i) => {
    const unique = [...new Set(rows.map(r => r[i]))]
      .filter(v => v !== null && v !== undefined && v !== '')
      .sort();
    const select = document.createElement('select');
    select.innerHTML = `<option value="">${col}</option>` +
      unique.map(v => `<option value="${v}">${v}</option>`).join('');
    select.onchange = () => {
      if(select.value) filters[col] = select.value;
      else delete filters[col];
      dt.column(i).search(select.value).draw();
    };
    filtersDiv.appendChild(select);
  });

}

function drawChart(name, rows, cols){
  const canvas = document.getElementById('preview');
  if(!rows.length){ canvas.classList.add('hidden'); return; }

  const normalize = s => s.toLowerCase().replace(/[^a-z\s]/g,'').replace(/\s+/g,'_').trim();
  const vtIdx   = cols.findIndex(c => normalize(c) === 'violation_type');
  const tagIdx  = cols.findIndex(c => normalize(c) === 'tags');
  const weekIdx = cols.findIndex(c => normalize(c) === 'week');
  if(vtIdx === -1){ canvas.classList.add('hidden'); return; }

  const ctx = canvas.getContext('2d');
  if(window.currentChart){ window.currentChart.destroy(); }
  canvas.classList.remove('hidden');
  canvas.style.backgroundColor = '#333';

  const colors = {
    'Missing Certifications': '#00bcd4',
    'Shift Duty Limit': '#ff8c00',
    'Shift Driving Limit': '#ffff00',
    'Cycle Limit': '#808080'
  };
  const canonical = v => {
    const t = String(v||'').toLowerCase();
    if(t.startsWith('missing')) return 'Missing Certifications';
    if(t.includes('duty')) return 'Shift Duty Limit';
    if(t.includes('driving')) return 'Shift Driving Limit';
    if(t.includes('cycle')) return 'Cycle Limit';
    return v;
  };

  if(weekIdx !== -1){
    const endStr = document.getElementById('trend-end').value;
    const endDate = endStr ? new Date(endStr) : new Date(rows[rows.length-1][weekIdx]);
    const startOfWeek = d => { const x=new Date(d); x.setDate(x.getDate()-x.getDay()); x.setHours(0,0,0,0); return x; };
    const endMon = startOfWeek(endDate);
    const weeks = [3,2,1,0].map(i=> new Date(endMon.getTime()-i*7*24*60*60*1000));
    const counts = {};
    rows.forEach(r=>{
      const type = canonical(r[vtIdx]);
      const wk   = startOfWeek(new Date(r[weekIdx])).getTime();
      if(!weeks.some(w=>w.getTime()===wk)) return;
      counts[type] = counts[type] || {};
      counts[type][wk] = (counts[type][wk]||0)+1;
    });
    const labels = weeks.map(w=>`${w.getMonth()+1}/${w.getDate()}/${w.getFullYear()}`);
    const datasets = Object.entries(colors).map(([t,c])=>({
      label: t,
      data: weeks.map(w=>counts[t]?.[w.getTime()]||0),
      borderColor: c,
      backgroundColor: c,
      fill: false
    }));
    window.currentChart = new Chart(ctx,{
      type: 'line',
      data:{ labels, datasets },
      options:{
        scales:{
          x:{ ticks:{color:'white'} },
          y:{ beginAtZero:true, max:200, ticks:{stepSize:50,color:'white'} }
        },
        plugins:{
          title:{display:true,text:'HOS 4-Week Trend Analysis',color:'white'},
          legend:{labels:{color:'white'}}
        }
      }
    });
    return;
  }

  if(tagIdx !== -1){
    const regions = ['GL','OV','SE'];
    const counts = {};
    rows.forEach(r=>{
      const tag = String(r[tagIdx]||'').toUpperCase();
      const reg = regions.find(x=>tag.includes(x));
      if(!reg) return;
      const type = canonical(r[vtIdx]);
      counts[reg] = counts[reg] || {};
      counts[reg][type] = (counts[reg][type]||0)+1;
    });
    const datasets = Object.entries(colors).map(([t,c])=>({
      label:t,
      data: regions.map(r=>counts[r]?.[t]||0),
      backgroundColor:c
    }));
    const total = datasets.reduce((s,d)=>s+d.data.reduce((a,b)=>a+b,0),0);
    window.currentChart = new Chart(ctx,{
      type:'bar',
      data:{ labels: regions, datasets },
      options:{
        scales:{
          x:{ stacked:true, ticks:{color:'white'} },
          y:{ beginAtZero:true, stacked:true, max:120, ticks:{stepSize:20,color:'white'} }
        },
        plugins:{
          title:{display:true,text:'HOS Violations',color:'white'},
          legend:{labels:{color:'white'}},
          subtitle:{display:true,text:`Total ${total}`,color:'white'}
        }
      }
    });
  }
}

</script>
<script src="/static/js/wizard.js"></script>
</body></html>
